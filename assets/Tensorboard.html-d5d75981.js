import{_ as s,W as n,X as a,a1 as p}from"./framework-179f767b.js";const t={},e=p(`<h1 id="数据处理" tabindex="-1"><a class="header-anchor" href="#数据处理" aria-hidden="true">#</a> 数据处理</h1><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">contrastive_loss</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> margin<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&#39;&#39;&#39;
    z是隐空间中的编码，labels是样本的标签
    计算同类样本对和异类样本对
    &#39;&#39;&#39;</span>
    n_samples <span class="token operator">=</span> z<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    same_class_mask <span class="token operator">=</span> <span class="token punctuation">(</span>labels<span class="token punctuation">.</span>view<span class="token punctuation">(</span>n_samples<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> labels<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n_samples<span class="token punctuation">)</span><span class="token punctuation">)</span>
    diff_class_mask <span class="token operator">=</span> <span class="token operator">~</span> same_class_mask
    same_class_indices <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>same_class_mask<span class="token punctuation">)</span>
    diff_class_indices <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>diff_class_mask<span class="token punctuation">)</span>
    same_class_pairs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>same_class_indices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> same_class_indices<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    diff_class_pairs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>diff_class_indices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> diff_class_indices<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 计算同类样本对的损失函数</span>
    same_class_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token keyword">in</span> same_class_pairs<span class="token punctuation">:</span>
        dist <span class="token operator">=</span> torch<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>z<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> z<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
        same_class_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dist <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
    same_class_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>same_class_losses<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 计算异类样本对的损失函数</span>
    diff_class_losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token keyword">in</span> diff_class_pairs<span class="token punctuation">:</span>
        dist <span class="token operator">=</span> torch<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>z<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> z<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
        diff_class_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>margin <span class="token operator">-</span> dist<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
    diff_class_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>diff_class_losses<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 添加正则项</span>
    <span class="token comment"># reg_loss = 0.0</span>
    <span class="token comment"># for param in model.parameters():</span>
    <span class="token comment">#     reg_loss += torch.sum(param ** 2)</span>
    <span class="token comment"># 将所有损失函数加权求和，并返回最终的损失值</span>
    total_loss <span class="token operator">=</span> same_class_loss <span class="token operator">+</span> diff_class_loss <span class="token comment"># + 0.01 * reg_loss</span>
    <span class="token keyword">return</span> total_loss
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),o=[e];function c(l,i){return n(),a("div",null,o)}const r=s(t,[["render",c],["__file","Tensorboard.html.vue"]]);export{r as default};
